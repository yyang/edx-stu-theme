<%! from django.core.urlresolvers import reverse %>
<!-- dummy segment.io -->
<script type="text/javascript">
  (function(){
    var methods = ["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"];

    var analytics = function() {
      var analyticsString = JSON.stringify({
        'method': arguments[0],
        'key': arguments[1],
        'content': arguments[2],
        'url': document.URL
      });

      var request = new XMLHttpRequest();
      request.onload = function(evt) {
        if (~~(request.status/100) !== 2) {
          console.error('Analytics Error: ', request.status);
        }
      };
      request.open('POST', 'http://localhost:4000/', true);
      request.setRequestHeader('Content-Type', 'application/json');
      request.send(JSON.stringify({'analytics': analyticsString}));
    }
    methods.forEach(function(method) {
      analytics[method] = analytics.bind(analytics, method);
    });

    window['analytics'] = analytics;

    % if user.is_authenticated():
      // Access the query string, stripping the leading "?"
      var queryString = window.location.search.substring(1);

      if (queryString != "") {
        // Convert the query string to a key/value object
        var parameters = window.parseQueryString(queryString);

        if ("signin" in parameters) {
          window.assessUserSignIn(parameters, "${user.id}", "${user.email}", "${user.username}");
        } else {
          window.identifyUser("${user.id}", "${user.email}", "${user.username}");
        }
      } else {
        window.identifyUser("${user.id}", "${user.email}", "${user.username}");
      }
    % endif

    // Get current page URL
    var url = window.location.href
    // Match on the current url and fire the appropriate pageview event
    if (url.indexOf("/register") > -1) {
      // Registration page viewed
      analytics.track("edx.bi.page.register.viewed", {
        category: "pageview",
        noninteraction: 1
      });
    } else if (url.indexOf("/login") > -1) {
      // Login page viewed
      analytics.track("edx.bi.page.login.viewed", {
        category: "pageview",
        noninteraction: 1
      });
    } else if (url.indexOf("/dashboard") > -1) {
      // Dashboard viewed
      analytics.track("edx.bi.page.dashboard.viewed", {
        category: "pageview",
        noninteraction: 1
      });
    } else {
      // This event serves as a catch-all, firing when any other page is viewed
      analytics.track("edx.bi.page.other.viewed", {
        category: "pageview",
        url: location.host + location.pathname + location.search,
        noninteraction: 1
      });
    }
  })()
  
</script>
<!-- end dummy segment.io -->
